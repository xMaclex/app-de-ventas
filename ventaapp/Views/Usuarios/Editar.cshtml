@model ventaapp.ViewModels.EditarUsuarioViewModel

@{
    ViewData["Title"] = "Editar Usuario";
}

<style>
    /* ── Tarjeta avatar ──────────────────────────────── */
    .avatar-wrapper {
        position: relative;
        width: 130px;
        height: 130px;
        margin: 0 auto;
    }
    .avatar-wrapper img {
        width: 130px;
        height: 130px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 18px rgba(79,142,247,.25);
    }
    .avatar-overlay {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: #4f8ef7;
        border: 3px solid #fff;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background .2s;
    }
    .avatar-overlay:hover { background: #2d6fd4; }
    .avatar-overlay i { color: #fff; font-size: 15px; }

    /* ── Campo de solo lectura ───────────────────────── */
    .campo-readonly {
        background: #f8f9fd !important;
        border-color: #e2e8f0 !important;
        color: #7a8899 !important;
        cursor: not-allowed;
    }
    .readonly-badge {
        font-size: .68rem;
        background: #eef2ff;
        color: #6c7bbf;
        border-radius: 20px;
        padding: 2px 8px;
        font-weight: 600;
        letter-spacing: .03em;
    }

    /* ── Secciones del formulario ─────────────────────── */
    .section-title {
        font-size: .75rem;
        font-weight: 700;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: #a0aec0;
        margin-bottom: 1rem;
        padding-bottom: .4rem;
        border-bottom: 1px solid #edf2f7;
    }

    /* ── Preview imagen seleccionada ─────────────────── */
    #preview-nueva {
        display: none;
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid #4f8ef7;
        box-shadow: 0 2px 8px rgba(79,142,247,.2);
    }
</style>

<div class="container-fluid px-4">

    <!-- Header -->
    <div class="d-flex align-items-center mb-4 mt-2 gap-3">
        <a asp-action="Index" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
        <div>
            <h2 class="fw-bold mb-0" style="color:#1e2a3a;">
                <i class="bi bi-person-gear me-2" style="color:#4f8ef7;"></i>Editar Usuario
            </h2>
            <small class="text-muted">Modifica los datos del usuario. Los campos únicos no son editables.</small>
        </div>
    </div>

    <form asp-action="Editar" method="post" enctype="multipart/form-data" id="formEditar">
        <input type="hidden" asp-for="IdUsuario" />

        <div class="row g-4">

            <!-- ── Columna izquierda: perfil visual ──────────────── -->
            <div class="col-lg-3">

                <!-- Tarjeta foto de perfil -->
                <div class="card border-0 shadow-sm text-center p-4 mb-3">
                    <div class="avatar-wrapper mb-3" onclick="document.getElementById('inputFoto').click();" title="Cambiar foto">
                        <img id="avatarPreview"
                             src="@Url.Action("FotoPerfil", "Usuarios", new { id = Model.IdUsuario })"
                             alt="Foto de perfil" />
                        <div class="avatar-overlay">
                            <i class="bi bi-camera-fill"></i>
                        </div>
                    </div>

                    <h5 class="fw-bold mb-0" style="color:#1e2a3a;">@Model.NombreCompleto</h5>
                    <small class="text-muted mb-3">@@@Model.Username</small>

                    <!-- Input oculto para la imagen -->
                    <input type="file"
                           asp-for="FotoPerfil"
                           id="inputFoto"
                           accept="image/jpeg,image/png,image/gif,image/webp"
                           class="d-none" />

                    <!-- Preview de nueva imagen seleccionada -->
                    <div id="contenedor-preview" class="mt-2" style="display:none;">
                        <p class="text-muted mb-1" style="font-size:.78rem;">Nueva foto seleccionada:</p>
                        <img id="preview-nueva" alt="Vista previa" />
                        <div class="mt-1">
                            <small id="nombre-archivo" class="text-muted"></small>
                        </div>
                    </div>

                    <span class="text-muted mt-2 d-block" style="font-size:.75rem;">
                        JPG, PNG, GIF o WEBP · Máx. 2MB<br>
                        Haz clic en la foto para cambiarla
                    </span>
                    <span asp-validation-for="FotoPerfil" class="text-danger small"></span>

                    @if (Model.FotoPerfilActual != null)
                    {
                        <hr class="my-3" />
                        <form asp-action="EliminarFoto" asp-route-id="@Model.IdUsuario" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill"
                                    onclick="return confirm('¿Eliminar la foto de perfil actual?')">
                                <i class="bi bi-trash3 me-1"></i>Quitar foto
                            </button>
                        </form>
                    }
                </div>

                <!-- Info de solo lectura -->
                <div class="card border-0 shadow-sm p-3">
                    <p class="section-title mb-2">Información del sistema</p>
                    <div class="mb-2">
                        <small class="text-muted d-block">Registro</small>
                        <span class="fw-semibold">@Model.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted d-block">Último acceso</small>
                        @if (Model.UltimoAcceso.HasValue)
                        {
                            <span class="fw-semibold">@Model.UltimoAcceso.Value.ToString("dd/MM/yyyy HH:mm")</span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">Sin accesos registrados</span>
                        }
                    </div>
                    @if (Model.EstaBloqueado)
                    {
                        <div class="alert alert-danger py-2 px-3 mb-0 mt-2" style="font-size:.82rem;">
                            <i class="bi bi-lock-fill me-1"></i>Cuenta bloqueada
                        </div>
                    }
                </div>
            </div>

            <!-- ── Columna derecha: formulario ───────────────────── -->
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm p-4">

                    <!-- Sección: Campos únicos (solo lectura) -->
                    <p class="section-title">
                        <i class="bi bi-shield-lock me-1"></i>Campos únicos
                        <span class="readonly-badge ms-2">No editables</span>
                    </p>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small">Nombre de usuario</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0 text-muted">
                                    <i class="bi bi-at"></i>
                                </span>
                                <input type="text" class="form-control campo-readonly border-start-0"
                                       value="@Model.Username" readonly />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold small">Tipo documento</label>
                            <input type="text" class="form-control campo-readonly"
                                   value="@Model.TipoDocumento" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold small">Número documento</label>
                            <input type="text" class="form-control campo-readonly"
                                   value="@Model.NumeroDocumento" readonly />
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Sección: Datos personales editables -->
                    <p class="section-title">
                        <i class="bi bi-person me-1"></i>Datos personales
                    </p>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="Nombre" class="form-label fw-semibold small"></label>
                            <input asp-for="Nombre" class="form-control" placeholder="Nombres del usuario" />
                            <span asp-validation-for="Nombre" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Apellidos" class="form-label fw-semibold small"></label>
                            <input asp-for="Apellidos" class="form-control" placeholder="Apellidos del usuario" />
                            <span asp-validation-for="Apellidos" class="text-danger small"></span>
                        </div>
                        <div class = "col-md-6">
                            <label asp-for="Email" class="form-label fw-semibold small"></label>
                            <input asp-for="Email" class="form-control" placeholder="Correo electrónico del usuario" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Sección: Contacto -->
                    <p class="section-title">
                        <i class="bi bi-telephone me-1"></i>Contacto
                    </p>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="NumeroTelefono" class="form-label fw-semibold small"></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-muted">
                                    <i class="bi bi-telephone"></i>
                                </span>
                                <input asp-for="NumeroTelefono" class="form-control" placeholder="809-000-0000" />
                            </div>
                            <span asp-validation-for="NumeroTelefono" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="NumeroCelular" class="form-label fw-semibold small"></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-muted">
                                    <i class="bi bi-phone"></i>
                                </span>
                                <input asp-for="NumeroCelular" class="form-control" placeholder="809-000-0000" />
                            </div>
                            <span asp-validation-for="NumeroCelular" class="text-danger small"></span>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Sección: Estado -->
                    <p class="section-title">
                        <i class="bi bi-toggle-on me-1"></i>Estado de la cuenta
                    </p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="Estado" class="form-label fw-semibold small"></label>
                            <select asp-for="Estado" class="form-select">
                                <option value="Activo">✅ Activo</option>
                                <option value="Inactivo">⛔ Inactivo</option>
                            </select>
                            <span asp-validation-for="Estado" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill px-4">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm" id="btnGuardar">
                            <i class="bi bi-floppy2-fill me-1"></i>Guardar Cambios
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Preview de imagen antes de subir
        document.getElementById('inputFoto').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('La imagen supera el tamaño máximo de 2MB.');
                this.value = '';
                return;
            }

            const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!tiposPermitidos.includes(file.type)) {
                alert('Solo se permiten imágenes JPG, PNG, GIF o WEBP.');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (ev) {
                // Actualizar avatar principal
                document.getElementById('avatarPreview').src = ev.target.result;
                // Mostrar preview secundario
                const previewNueva = document.getElementById('preview-nueva');
                previewNueva.src = ev.target.result;
                previewNueva.style.display = 'inline-block';
                document.getElementById('contenedor-preview').style.display = 'block';
                document.getElementById('nombre-archivo').textContent = file.name;
            };
            reader.readAsDataURL(file);
        });

        // Feedback visual al guardar
        document.getElementById('formEditar').addEventListener('submit', function () {
            const btn = document.getElementById('btnGuardar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
        });
    </script>
}
