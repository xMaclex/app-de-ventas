@model ventaapp.Models.Producto

@{
    ViewData["Title"] = "Detalles del Producto";
}

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-box-seam"></i> Detalles del Producto</h2>
                <div>
                    <a asp-action="Edit" asp-route-id="@Model.IdProducto" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a asp-action="CambiarEstado" asp-route-id="@Model.IdProducto" 
                       class="btn btn-@(Model.Estado == "Activo" ? "secondary" : "success")">
                        <i class="bi bi-power"></i> @(Model.Estado == "Activo" ? "Desactivar" : "Activar")
                    </a>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna Izquierda - Información del Producto -->
        <div class="col-md-8">
            <!-- Información Básica -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Producto</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-hash"></i> ID Producto:</strong>
                        </div>
                        <div class="col-md-8">
                            @Model.IdProducto
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-upc"></i> Código:</strong>
                        </div>
                        <div class="col-md-8">
                            <code class="fs-5">@Model.CodigoProducto</code>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-box"></i> Nombre:</strong>
                        </div>
                        <div class="col-md-8">
                            <h5 class="text-primary mb-0">@Model.NombreProducto</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-card-text"></i> Descripción:</strong>
                        </div>
                        <div class="col-md-8">
                            @if (!string.IsNullOrEmpty(Model.Descripcion))
                            {
                                <p class="mb-0">@Model.Descripcion</p>
                            }
                            else
                            {
                                <span class="text-muted">Sin descripción</span>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-tag"></i> Categoría:</strong>
                        </div>
                        <div class="col-md-8">
                            <span class="badge bg-secondary fs-6">@Model.Categoria</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong><i class="bi bi-toggle-on"></i> Estado:</strong>
                        </div>
                        <div class="col-md-8">
                            @if (Model.Estado == "Activo")
                            {
                                <span class="badge bg-success fs-6">@Model.Estado</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary fs-6">@Model.Estado</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de Precios -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Información de Precios</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Precio de Compra</h6>
                                    <h3 class="text-primary mb-0">$@Model.PrecioCompra.ToString("N2")</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Precio de Venta</h6>
                                    <h3 class="text-success mb-0">$@Model.PrecioVenta.ToString("N2")</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Utilidad por Unidad:</strong></div>
                        <div class="col-6 text-end">
                            <span class="badge bg-info fs-6">$@Model.Utilidad.ToString("N2")</span>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Margen de Ganancia:</strong></div>
                        <div class="col-6 text-end">
                            @if (Model.MargenGanancia > 30)
                            {
                                <span class="badge bg-success fs-6">@Model.MargenGanancia.ToString("N1")%</span>
                            }
                            else if (Model.MargenGanancia > 15)
                            {
                                <span class="badge bg-warning fs-6">@Model.MargenGanancia.ToString("N1")%</span>
                            }
                            else
                            {
                                <span class="badge bg-danger fs-6">@Model.MargenGanancia.ToString("N1")%</span>
                            }
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Impuesto (ITBIS):</strong></div>
                        <div class="col-6 text-end">@Model.Impuesto.ToString("N2")%</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Monto de Impuesto:</strong></div>
                        <div class="col-6 text-end">$@((Model.PrecioVenta * Model.Impuesto / 100).ToString("N2"))</div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-6"><strong>Precio Final al Cliente:</strong></div>
                        <div class="col-6 text-end">
                            <h4 class="text-success mb-0">$@Model.PrecioConImpuesto.ToString("N2")</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Ventas -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Ventas</h5>
                </div>
                <div class="card-body">
                    @if (Model.Facturas.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Número Factura</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>NCF</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var factura in Model.Facturas.OrderByDescending(f => f.FechaEmision).Take(10))
                                    {
                                        <tr>
                                            <td><strong>@factura.NumeroFactura</strong></td>
                                            <td>@factura.FechaEmision.ToString("dd/MM/yyyy")</td>
                                            <td>@factura.Cliente.NombreCompleto</td>
                                            <td><code>@factura.Ncf</code></td>
                                            <td>
                                                @if (factura.Estado == "Activa")
                                                {
                                                    <span class="badge bg-success">@factura.Estado</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">@factura.Estado</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (Model.Facturas.Count > 10)
                        {
                            <p class="text-muted text-center mb-0">Mostrando las últimas 10 ventas de @Model.Facturas.Count</p>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">Este producto aún no se ha vendido.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Columna Derecha - Estadísticas -->
        <div class="col-md-4">
            <!-- Estadísticas -->
            <div class="card mb-3 text-white bg-primary">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Vendido</h6>
                    <h2>@ViewBag.TotalVendido</h2>
                    <small>Unidades</small>
                </div>
            </div>

            <div class="card mb-3 text-white bg-success">
                <div class="card-body text-center">
                    <h6 class="card-title">Ingresos Generados</h6>
                    <h2>$@((Model.PrecioVenta * ViewBag.TotalVendido).ToString("N2"))</h2>
                    <small>Total en ventas</small>
                </div>
            </div>

            <div class="card mb-3 text-white bg-info">
                <div class="card-body text-center">
                    <h6 class="card-title">Última Venta</h6>
                    @if (ViewBag.UltimaVenta != null)
                    {
                        <p class="mb-0">@ViewBag.UltimaVenta.ToString("dd/MM/yyyy")</p>
                        <small>@ViewBag.UltimaVenta.ToString("hh:mm tt")</small>
                    }
                    else
                    {
                        <p class="mb-0">Sin ventas</p>
                    }
                </div>
            </div>

            <div class="card mb-3 text-white bg-warning">
                <div class="card-body text-center">
                    <h6 class="card-title">Ganancia Total</h6>
                    <h2>$@((Model.Utilidad * ViewBag.TotalVendido).ToString("N2"))</h2>
                    <small>Utilidad generada</small>
                </div>
            </div>

            <!-- Análisis de Rentabilidad -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-graph-up"></i> Análisis</h6>
                </div>
                <div class="card-body">
                    @if (Model.MargenGanancia > 30)
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Excelente rentabilidad</strong><br>
                            Este producto tiene un margen superior al 30%.
                        </div>
                    }
                    else if (Model.MargenGanancia > 15)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Rentabilidad aceptable</strong><br>
                            Margen entre 15% y 30%.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-x-circle-fill"></i>
                            <strong>Margen bajo</strong><br>
                            Considera ajustar los precios.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}
