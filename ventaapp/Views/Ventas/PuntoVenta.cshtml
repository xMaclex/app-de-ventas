@model ventaapp.Models.PuntoVentaViewModel

@{
    ViewData["Title"] = "Punto de Venta";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2><i class="bi bi-cart-check"></i> Punto de Venta</h2>
        </div>
    </div>

    <form asp-action="ProcesarVenta" method="post" id="formVenta">
        <input type="hidden" name="carritoJson" id="carritoJson" />
        
        <div class="row">
            <!-- Columna Izquierda - Búsqueda y Productos -->
            <div class="col-md-7">
                <!-- Búsqueda de Productos -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-search"></i> Buscar Producto</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                            <input type="text" class="form-control" id="buscarProducto" 
                                   placeholder="Escanear código de barras o buscar producto..." 
                                   autocomplete="off">
                            <button class="btn btn-primary" type="button" id="btnBuscar">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                        
                        <!-- Resultados de búsqueda -->
                        <div id="resultadosBusqueda" class="mt-3"></div>
                    </div>
                </div>

                <!-- Carrito de Compras -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-cart3"></i> Carrito de Compras</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped mb-0" id="tablaCarrito">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="carritoBody">
                                    <tr id="carritoVacio">
                                        <td colspan="5" class="text-center text-muted py-5">
                                            <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                                            <p class="mt-2">El carrito está vacío</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha - Resumen y Pago -->
            <div class="col-md-5">
                <!-- Selección de Cliente -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-person"></i> Cliente</h6>
                    </div>
                    <div class="card-body">
                        <select asp-for="Venta.IdCliente" class="form-select" required>
                            <option value="">-- Seleccione un cliente --</option>
                            @foreach (var cliente in Model.Clientes)
                            {
                                <option value="@cliente.IdCliente">@cliente.NombreCompleto - @cliente.NumeroDocumento</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Resumen de Venta -->
                <div class="card mb-3">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="bi bi-calculator"></i> Resumen</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6"><strong>Subtotal:</strong></div>
                            <div class="col-6 text-end fs-5" id="displaySubtotal">$0.00</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>ITBIS (18%):</strong></div>
                            <div class="col-6 text-end fs-5" id="displayItbis">$0.00</div>
                        </div>
                        <hr>
                        
                        <!-- Descuento -->
                        <div class="row mb-2">
                            <div class="col-12">
                                <label class="form-label"><strong>Descuento:</strong></label>
                                <div class="input-group">
                                    <input type="number" asp-for="Venta.Descuento" class="form-control" 
                                           id="inputDescuento" min="0" step="0.01" value="0">
                                    <select asp-for="Venta.TipoDescuento" class="form-select" id="tipoDescuento" style="max-width: 120px;">
                                        <option value="Monto">$</option>
                                        <option value="Porcentaje">%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><small>Descuento aplicado:</small></div>
                            <div class="col-6 text-end" id="displayDescuento">$0.00</div>
                        </div>
                        <hr>
                        
                        <div class="row">
                            <div class="col-6"><strong>TOTAL:</strong></div>
                            <div class="col-6 text-end">
                                <h3 class="text-success mb-0" id="displayTotal">$0.00</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Método de Pago -->
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-credit-card"></i> Método de Pago</h6>
                    </div>
                    <div class="card-body">
                        <select asp-for="Venta.MetodoPago" class="form-select mb-2" required>
                            <option value="">-- Seleccione --</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                            <option value="Transferencia">Transferencia Bancaria</option>
                            <option value="Cheque">Cheque</option>
                        </select>

                        <label class="form-label">Tipo de Comprobante:</label>
                        <select asp-for="Venta.TipoComprobante" class="form-select mb-2" required>
                            <option value="">-- Seleccione --</option>
                            <option value="B01">B01 - Crédito Fiscal</option>
                            <option value="B02">B02 - Consumidor Final</option>
                            <option value="B14">B14 - Régimen Especial</option>
                            <option value="B15">B15 - Gubernamental</option>
                        </select>

                        <label class="form-label">Tipo de Venta:</label>
                        <select asp-for="Venta.TipoVenta" class="form-select" required>
                            <option value="Contado">Contado</option>
                            <option value="Crédito">Crédito</option>
                        </select>
                    </div>
                </div>

                <!-- Notas -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="bi bi-sticky"></i> Notas (Opcional)</h6>
                    </div>
                    <div class="card-body">
                        <textarea asp-for="Venta.Notas" class="form-control" rows="2" 
                                  placeholder="Comentarios adicionales..."></textarea>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-success btn-lg w-100 mb-2" id="btnProcesarVenta">
                            <i class="bi bi-check-circle"></i> Procesar Venta
                        </button>
                        <button type="button" class="btn btn-danger btn-lg w-100" id="btnCancelar">
                            <i class="bi bi-x-circle"></i> Cancelar / Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script>
        // Variables globales
        let carrito = [];
        
        // Función para buscar productos
        async function buscarProductos(termino) {
            if (termino.length < 2) return;
            
            try {
                const response = await fetch(`/Ventas/BuscarProducto?termino=${encodeURIComponent(termino)}`);
                const productos = await response.json();
                
                mostrarResultados(productos);
            } catch (error) {
                console.error('Error al buscar productos:', error);
            }
        }
        
        // Mostrar resultados de búsqueda
        function mostrarResultados(productos) {
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            
            if (productos.length === 0) {
                resultadosDiv.innerHTML = '<div class="alert alert-info">No se encontraron productos</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            productos.forEach(producto => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action" 
                       onclick="agregarAlCarrito(${producto.idProducto}, '${producto.codigoProducto}', 
                                                 '${producto.nombreProducto}', ${producto.precioVenta}, 
                                                 ${producto.impuesto}); return false;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${producto.nombreProducto}</strong><br>
                                <small class="text-muted">Código: ${producto.codigoProducto}</small>
                            </div>
                            <div class="text-end">
                                <h5 class="mb-0 text-success">$${producto.precioVenta.toFixed(2)}</h5>
                                <small class="text-muted">+${producto.impuesto}% ITBIS</small>
                            </div>
                        </div>
                    </a>
                `;
            });
            html += '</div>';
            
            resultadosDiv.innerHTML = html;
        }
        
        // Agregar producto al carrito
        function agregarAlCarrito(idProducto, codigo, nombre, precio, impuesto) {
            // Verificar si el producto ya está en el carrito
            const itemExistente = carrito.find(item => item.IdProducto === idProducto);
            
            if (itemExistente) {
                itemExistente.Cantidad++;
            } else {
                carrito.push({
                    IdProducto: idProducto,
                    CodigoProducto: codigo,
                    NombreProducto: nombre,
                    PrecioUnitario: precio,
                    Cantidad: 1,
                    Impuesto: impuesto
                });
            }
            
            actualizarCarrito();
            document.getElementById('buscarProducto').value = '';
            document.getElementById('resultadosBusqueda').innerHTML = '';
        }
        
        // Actualizar visualización del carrito
        function actualizarCarrito() {
            const tbody = document.getElementById('carritoBody');
            const carritoVacio = document.getElementById('carritoVacio');
            
            if (carrito.length === 0) {
                carritoVacio.style.display = 'table-row';
                tbody.querySelectorAll('tr:not(#carritoVacio)').forEach(tr => tr.remove());
            } else {
                carritoVacio.style.display = 'none';
                
                // Limpiar tbody excepto carritoVacio
                tbody.querySelectorAll('tr:not(#carritoVacio)').forEach(tr => tr.remove());
                
                // Agregar items del carrito
                carrito.forEach((item, index) => {
                    const subtotal = item.PrecioUnitario * item.Cantidad;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <strong>${item.NombreProducto}</strong><br>
                            <small class="text-muted">${item.CodigoProducto}</small>
                        </td>
                        <td class="text-center">
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="cambiarCantidad(${index}, -1)">-</button>
                                <input type="number" class="form-control text-center" 
                                       value="${item.Cantidad}" min="1" 
                                       onchange="actualizarCantidad(${index}, this.value)">
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="cambiarCantidad(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-end">$${item.PrecioUnitario.toFixed(2)}</td>
                        <td class="text-end"><strong>$${subtotal.toFixed(2)}</strong></td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="eliminarDelCarrito(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            calcularTotales();
        }
        
        // Cambiar cantidad
        function cambiarCantidad(index, delta) {
            carrito[index].Cantidad += delta;
            if (carrito[index].Cantidad < 1) {
                carrito[index].Cantidad = 1;
            }
            actualizarCarrito();
        }
        
        // Actualizar cantidad
        function actualizarCantidad(index, nuevaCantidad) {
            const cantidad = parseInt(nuevaCantidad);
            if (cantidad > 0) {
                carrito[index].Cantidad = cantidad;
                actualizarCarrito();
            }
        }
        
        // Eliminar del carrito
        function eliminarDelCarrito(index) {
            carrito.splice(index, 1);
            actualizarCarrito();
        }
        
        // Calcular totales
        function calcularTotales() {
            let subtotal = 0;
            let itbis = 0;
            
            carrito.forEach(item => {
                const itemSubtotal = item.PrecioUnitario * item.Cantidad;
                subtotal += itemSubtotal;
                itbis += itemSubtotal * (item.Impuesto / 100);
            });
            
            // Calcular descuento
            const descuentoInput = parseFloat(document.getElementById('inputDescuento').value) || 0;
            const tipoDescuento = document.getElementById('tipoDescuento').value;
            let descuento = 0;
            
            if (tipoDescuento === 'Porcentaje') {
                descuento = subtotal * (descuentoInput / 100);
            } else {
                descuento = descuentoInput;
            }
            
            const total = subtotal + itbis - descuento;
            
            // Actualizar display
            document.getElementById('displaySubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('displayItbis').textContent = '$' + itbis.toFixed(2);
            document.getElementById('displayDescuento').textContent = '-$' + descuento.toFixed(2);
            document.getElementById('displayTotal').textContent = '$' + total.toFixed(2);
        }
        
        // Event listeners
        document.getElementById('buscarProducto').addEventListener('input', function(e) {
            buscarProductos(e.target.value);
        });
        
        document.getElementById('buscarProducto').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarProductos(e.target.value);
            }
        });
        
        document.getElementById('btnBuscar').addEventListener('click', function() {
            buscarProductos(document.getElementById('buscarProducto').value);
        });
        
        document.getElementById('inputDescuento').addEventListener('input', calcularTotales);
        document.getElementById('tipoDescuento').addEventListener('change', calcularTotales);
        
        document.getElementById('btnCancelar').addEventListener('click', function() {
            if (confirm('¿Está seguro de que desea cancelar y limpiar el carrito?')) {
                carrito = [];
                actualizarCarrito();
                document.getElementById('formVenta').reset();
            }
        });
        
        // Al enviar el formulario
        document.getElementById('formVenta').addEventListener('submit', function(e) {
            if (carrito.length === 0) {
                e.preventDefault();
                alert('El carrito está vacío. Agregue productos antes de procesar la venta.');
                return false;
            }
            
            // Serializar el carrito a JSON
            document.getElementById('carritoJson').value = JSON.stringify(carrito);
        });
    </script>
}
