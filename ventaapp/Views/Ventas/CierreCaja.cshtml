@model IEnumerable<ventaapp.Models.Venta>

@{
    ViewData["Title"] = "Cierre de Caja";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-cash-stack"></i> Cierre de Caja</h2>
                <div>
                    <button onclick="window.print()" class="btn btn-primary">
                        <i class="bi bi-printer"></i> Imprimir Cierre
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de Fecha -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="CierreCaja" method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Fecha del Cierre:</label>
                    <input type="date" name="fecha" class="form-control" 
                           value="@ViewBag.FechaCierre.ToString("yyyy-MM-dd")" 
                           max="@DateTime.Today.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Consultar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Información del Cierre -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-check"></i> 
                        Cierre del @ViewBag.FechaCierre.ToString("dddd, dd MMMM yyyy")
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Total Transacciones</h6>
                                <h2 class="text-primary mb-0">@ViewBag.TotalVentas</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Monto Total</h6>
                                <h2 class="text-success mb-0">$@ViewBag.MontoTotal.ToString("N2")</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Ticket Promedio</h6>
                                <h2 class="text-info mb-0">
                                    @if (ViewBag.TotalVentas > 0)
                                    {
                                        @($"${(ViewBag.MontoTotal / ViewBag.TotalVentas):N2}")
                                    }
                                    else
                                    {
                                        @:$0.00
                                    }
                                </h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Productos Vendidos</h6>
                                <h2 class="text-warning mb-0">@Model.Sum(v => v.Facturas.Count)</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Desglose por Método de Pago -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-wallet2"></i> Desglose por Método de Pago</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Método</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="bi bi-cash"></i> <strong>Efectivo</strong></td>
                                <td class="text-center">
                                    @Model.Count(v => v.MetodoPago == "Efectivo")
                                </td>
                                <td class="text-end">
                                    <strong>$@ViewBag.TotalEfectivo.ToString("N2")</strong>
                                </td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-credit-card"></i> <strong>Tarjeta</strong></td>
                                <td class="text-center">
                                    @Model.Count(v => v.MetodoPago == "Tarjeta")
                                </td>
                                <td class="text-end">
                                    <strong>$@ViewBag.TotalTarjeta.ToString("N2")</strong>
                                </td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-bank"></i> <strong>Transferencia</strong></td>
                                <td class="text-center">
                                    @Model.Count(v => v.MetodoPago == "Transferencia")
                                </td>
                                <td class="text-end">
                                    <strong>$@ViewBag.TotalTransferencia.ToString("N2")</strong>
                                </td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>TOTAL</strong></td>
                                <td class="text-center"><strong>@ViewBag.TotalVentas</strong></td>
                                <td class="text-end"><h5 class="mb-0">$@ViewBag.MontoTotal.ToString("N2")</h5></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Gráfico de Pastel -->
                    <canvas id="chartMetodosPago" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Resumen de Impuestos y Descuentos -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Resumen Fiscal</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <td><strong>Subtotal (sin impuestos)</strong></td>
                                <td class="text-end">$@Model.Sum(v => v.Subtotal).ToString("N2")</td>
                            </tr>
                            <tr>
                                <td><strong>ITBIS (18%)</strong></td>
                                <td class="text-end text-primary">$@Model.Sum(v => v.Itbis).ToString("N2")</td>
                            </tr>
                            <tr>
                                <td><strong>Descuentos Aplicados</strong></td>
                                <td class="text-end text-danger">-$@Model.Sum(v => v.Descuento).ToString("N2")</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>TOTAL NETO</strong></td>
                                <td class="text-end"><h5 class="mb-0">$@ViewBag.MontoTotal.ToString("N2")</h5></td>
                            </tr>
                        </tbody>
                    </table>

                    <hr>

                    <h6 class="text-muted">Desglose por Tipo de Venta:</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>Ventas de Contado:</td>
                            <td class="text-end">
                                <strong>@Model.Count(v => v.TipoVenta == "Contado")</strong>
                            </td>
                            <td class="text-end">
                                $@Model.Where(v => v.TipoVenta == "Contado").Sum(v => v.Total).ToString("N2")
                            </td>
                        </tr>
                        <tr>
                            <td>Ventas a Crédito:</td>
                            <td class="text-end">
                                <strong>@Model.Count(v => v.TipoVenta == "Crédito")</strong>
                            </td>
                            <td class="text-end">
                                $@Model.Where(v => v.TipoVenta == "Crédito").Sum(v => v.Total).ToString("N2")
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalle de Transacciones -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Detalle de Transacciones</h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Hora</th>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Método</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-end">ITBIS</th>
                                        <th class="text-end">Desc.</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var venta in Model.OrderBy(v => v.Fechaventa))
                                    {
                                        <tr>
                                            <td>@venta.Fechaventa.ToString("HH:mm:ss")</td>
                                            <td>
                                                <a asp-action="Details" asp-route-id="@venta.IdVenta">
                                                    #@venta.IdVenta
                                                </a>
                                            </td>
                                            <td>@venta.Cliente.NombreCompleto</td>
                                            <td><span class="badge bg-secondary">@venta.MetodoPago</span></td>
                                            <td class="text-end">$@venta.Subtotal.ToString("N2")</td>
                                            <td class="text-end">$@venta.Itbis.ToString("N2")</td>
                                            <td class="text-end text-danger">
                                                @if (venta.Descuento > 0)
                                                {
                                                    @($"-${venta.Descuento:N2}")
                                                }
                                                else
                                                {
                                                    @:---
                                                }
                                            </td>
                                            <td class="text-end"><strong>$@venta.Total.ToString("N2")</strong></td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-success">
                                    <tr>
                                        <th colspan="4" class="text-end">TOTALES:</th>
                                        <th class="text-end">$@Model.Sum(v => v.Subtotal).ToString("N2")</th>
                                        <th class="text-end">$@Model.Sum(v => v.Itbis).ToString("N2")</th>
                                        <th class="text-end text-danger">-$@Model.Sum(v => v.Descuento).ToString("N2")</th>
                                        <th class="text-end"><strong>$@ViewBag.MontoTotal.ToString("N2")</strong></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">No hay transacciones registradas para esta fecha.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Firma y Confirmación -->
    @if (Model.Any())
    {
        <div class="row mt-4 mb-4 no-print">
            <div class="col-md-12">
                <div class="card border-warning">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Responsable del Cierre:</h6>
                                <div class="border-bottom pb-2 mb-2">
                                    <p class="mb-0"><strong>Usuario:</strong> Sistema</p>
                                    <p class="mb-0"><strong>Fecha/Hora:</strong> @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")</p>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button onclick="window.print()" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Confirmar e Imprimir Cierre
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // Gráfico de pastel para métodos de pago
        var ctx = document.getElementById('chartMetodosPago').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Efectivo', 'Tarjeta', 'Transferencia'],
                datasets: [{
                    data: [
                        @ViewBag.TotalEfectivo,
                        @ViewBag.TotalTarjeta,
                        @ViewBag.TotalTransferencia
                    ],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.7)',
                        'rgba(13, 110, 253, 0.7)',
                        'rgba(255, 193, 7, 0.7)'
                    ],
                    borderColor: [
                        'rgba(25, 135, 84, 1)',
                        'rgba(13, 110, 253, 1)',
                        'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed || 0;
                                return label + ': $' + value.toLocaleString('en-US', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    </script>

    <style>
        @@media print {
            .no-print, .btn, nav, footer {
                display: none !important;
            }
            .card {
                border: 1px solid #000 !important;
                page-break-inside: avoid;
            }
        }
    </style>
}
